<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Song Meaning Summarizer</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121923;
      --panel-2: #0e1520;
      --text: #e6eef7;
      --muted: #a6b3c2;
      --accent: #6aa6ff;
      --accent-2:#8bdb81;
      --danger: #ff6b6b;
      --ring: rgba(106,166,255,.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f6f8fb;
        --panel: #ffffff;
        --panel-2:#f0f4f9;
        --text: #0c1624;
        --muted: #415063;
        --accent: #2463eb;
        --accent-2:#15803d;
        --danger: #dc2626;
        --ring: rgba(36,99,235,.2);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 80% -10%, rgba(106,166,255,.15), transparent 60%),
                  radial-gradient(900px 700px at -10% 10%, rgba(139,219,129,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.6;
    }
    .container{max-width:980px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display:grid;place-items:center;color:white;font-weight:900;
      box-shadow:0 6px 25px rgba(0,0,0,.25), 0 0 0 6px rgba(106,166,255,.08);
    }
    .title{font-size:1.35rem;margin:0}
    .subtitle{margin:2px 0 0;color:var(--muted);font-size:.95rem}
    .card{background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.18)}
    form{display:grid;grid-template-columns:1fr;gap:12px}
    .grid{display:grid;gap:12px}
    @media(min-width:720px){
      form .grid{grid-template-columns:1fr 1fr}
    }
    label{font-weight:600}
    input, button{font:inherit}
    .input{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px; padding:12px 14px}
    .input input{flex:1;background:transparent;border:0;outline:none;color:var(--text)}
    .hint{color:var(--muted);font-size:.85rem;margin-top:4px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:0; border-radius:12px; padding:12px 16px; cursor:pointer; font-weight:700;background:linear-gradient(135deg, var(--accent), #90b6ff); color:white;box-shadow:0 8px 24px rgba(36,99,235,.35); transition:transform .06s ease}
    .btn.secondary{background:transparent;color:var(--text);border:1px dashed rgba(255,255,255,.2);box-shadow:none}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed;filter:grayscale(.3)}
    .results{margin-top:18px; display:grid; gap:14px}
    .result-grid{display:grid; gap:14px}
    @media(min-width:920px){.result-grid{grid-template-columns: 1.1fr .9fr}}
    .summary{white-space:pre-wrap; word-wrap:break-word; background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.06);border-radius:12px; padding:14px; min-height:130px; max-height:200px; overflow-y:scroll; line-height:1.6; box-sizing:border-box}
    figure{margin:0; overflow:hidden; border-radius:12px; background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.06)}
    .preview{display:block; width:100%; height:auto}
    .skeleton{animation:pulse 1.2s ease-in-out infinite; background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06)); background-size:200% 100%}
    @keyframes pulse{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .alert{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,0,0,.1);color:#ffd6d6}
    .footer{margin-top:26px; color:var(--muted); font-size:.9rem}
    .kbd{padding:2px 6px;border-radius:6px; border:1px solid rgba(255,255,255,.25); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .input:focus-within, .btn:focus{outline:none; box-shadow:0 0 0 .2rem var(--ring)}
    .summary::-webkit-scrollbar{width:10px}
    .summary::-webkit-scrollbar-track{background:rgba(255,255,255,.06);border-radius:5px;margin:4px}
    .summary::-webkit-scrollbar-thumb{background:rgba(255,255,255,.3);border-radius:5px;border:1px solid rgba(255,255,255,.1)}
    .summary::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.5)}
    .summary{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.3) rgba(255,255,255,.06)}
    .progress-container{margin:12px 0;padding:12px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.06);border-radius:12px;display:none}
    .progress-bar{width:100%;height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin-bottom:8px}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:4px;transition:width .3s ease;width:0%}
    .progress-status{color:var(--muted);font-size:.9rem;text-align:center}
    .music-player{margin-top:18px;background:linear-gradient(180deg, var(--panel), var(--panel-2));border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:18px}
    .player-container{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .track-info{display:flex;gap:12px;align-items:center;flex:1;min-width:280px}
    .track-artwork{width:64px;height:64px;border-radius:8px;object-fit:cover;background:rgba(255,255,255,.06)}
    .track-details{flex:1}
    .track-title{font-weight:600;font-size:1.1rem;margin-bottom:4px}
    .track-artist{color:var(--muted);font-size:.9rem}
    .player-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spotify-btn{background:linear-gradient(135deg, #1db954, #1ed760);color:white;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .preview-btn{background:linear-gradient(135deg, var(--accent-2), #7dd87a);color:white}
    @media(max-width:720px){.player-container{flex-direction:column;align-items:stretch}.track-info{justify-content:center}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">‚ô™</div>
        <div>
          <h1 class="title">Song Meaning Summarizer</h1>
          <p class="subtitle">Type an <strong>artist</strong> and <strong>song title</strong>. Get a concise meaning + an AI-generated artwork using DALL-E.</p>
        </div>
      </div>
    </header>
    <section class="card">
      <form id="song-form" novalidate>
        <div class="grid">
          <div>
            <label for="artist">Artist</label>
            <div class="input"><input id="artist" name="artist" placeholder="e.g., Metallica" required /></div>
          </div>
          <div>
            <label for="title">Song title</label>
            <div class="input"><input id="title" name="title" placeholder="e.g., Nothing Else Matters" required /></div>
          </div>
        </div>
        <div class="grid">
          <div>
            <label for="style">Image style (optional)</label>
            <div class="input"><input id="style" name="style" placeholder="album cover, cinematic, watercolor, grunge, vintage‚Ä¶" /></div>
          </div>
          <div>
            <label for="language">Summary language</label>
            <div class="input">
              <select id="language" name="language" style="flex:1;background:transparent;border:0;outline:none;color:var(--text)">
                <option value="en">English</option>
                <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
              </select>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="summarize-btn" type="button">Summarize</button>
          <button class="btn" id="generate-btn" type="button">Generate Image</button>
          <button class="btn" id="analyze-btn" type="submit">Both</button>
          <button class="btn secondary" type="button" id="demo-btn">Try demo</button>
        </div>
        <p id="error" class="alert" style="display:none"></p>
        <div id="progress-container" class="progress-container">
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <div id="progress-status" class="progress-status">Starting...</div>
        </div>
      </form>
      <div id="results" class="results" hidden>
        <div class="result-grid">
          <div>
            <h3>Meaning</h3>
            <div id="summary" class="summary"></div>
          </div>
          <div>
            <h3>Imagery</h3>
            <figure><img id="image" class="preview" alt="" /></figure>
          </div>
        </div>
        <div id="music-player" class="music-player" style="display:none;">
          <h3>üéµ Listen on Spotify</h3>
          <div class="player-container">
            <div class="track-info">
              <img id="track-image" class="track-artwork" alt="Album artwork" />
              <div class="track-details">
                <div id="track-name" class="track-title"></div>
                <div id="track-artist" class="track-artist"></div>
              </div>
            </div>
            <div class="player-controls">
              <audio id="preview-audio" controls style="display:none;"></audio>
              <div id="preview-controls" class="preview-controls" style="display:none;">
                <button id="play-preview-btn" class="btn preview-btn">üéµ Preview (30s)</button>
              </div>
              <a id="open-spotify-btn" class="btn spotify-btn" target="_blank" rel="noopener">
                üéß Open in Spotify
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <script>
    const $ = id => document.getElementById(id);
    const form = $("song-form"), btn = $("analyze-btn"), demoBtn = $("demo-btn"), errorEl = $("error");
    const summarizeBtn = $("summarize-btn"), generateBtn = $("generate-btn");
    const results = $("results"), summaryEl = $("summary"), imageEl = $("image");
    const progressContainer = $("progress-container"), progressFill = $("progress-fill"), progressStatus = $("progress-status");
    
    // Spotify elements
    const musicPlayer = $("music-player");
    const trackImage = $("track-image"), trackName = $("track-name"), trackArtist = $("track-artist");
    const previewAudio = $("preview-audio"), previewControls = $("preview-controls"), playPreviewBtn = $("play-preview-btn");
    const openSpotifyBtn = $("open-spotify-btn");
    
    // Debug: Check if all elements exist
    console.log('Debug: Elements check:', {
      form: !!form, btn: !!btn, demoBtn: !!demoBtn, 
      summarizeBtn: !!summarizeBtn, generateBtn: !!generateBtn,
      results: !!results, summaryEl: !!summaryEl, imageEl: !!imageEl
    });
    
    function toBase64UTF8(str){const bytes=new TextEncoder().encode(str);let binary="";bytes.forEach(b=>binary+=String.fromCharCode(b));return btoa(binary);}
    function escapeXML(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&apos;");}
    
    function setLoading(l){
      btn.disabled=l; 
      summarizeBtn.disabled=l;
      generateBtn.disabled=l;
      progressContainer.style.display = l ? 'block' : 'none';
      if(l){
        results.hidden=false;
        progressFill.style.width = '0%';
        progressStatus.textContent = 'Starting...';
      }
    }
    
    function updateProgress(percent, status){
      progressFill.style.width = percent + '%';
      progressStatus.textContent = status;
    }
    
    function showError(msg){errorEl.textContent=msg;errorEl.style.display='block';setTimeout(()=>errorEl.style.display='none',4000);}
    
    async function startAnalysis({artist,title,style,language}){
      const res=await fetch('/api/analyze/start',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({artist,title,style,language})
      });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    
    function connectToProgress(requestId) {
      const eventSource = new EventSource(`/api/progress/${requestId}`);
      
      eventSource.onmessage = async function(event) {
        const data = JSON.parse(event.data);
        
        if(data.error) {
          showError(data.error);
          setLoading(false);
          eventSource.close();
          return;
        }
        
        updateProgress(data.progress, data.status);
        
        if(data.result) {
          summaryEl.textContent = data.result.summary;
          imageEl.src = data.result.imageUrl;
          // Also search for Spotify track when full analysis completes
          const artist = form.artist.value.trim();
          const title = form.title.value.trim();
          if (artist && title) {
            try {
              const spotifyData = await searchSpotify({artist, title});
              displaySpotifyTrack(spotifyData);
            } catch(e) {
              console.log('Spotify search failed:', e);
            }
          }
        }
        
        if(data.progress >= 100) {
          setLoading(false);
          eventSource.close();
        }
      };
      
      eventSource.onerror = function() {
        showError('Connection lost. Please try again.');
        setLoading(false);
        eventSource.close();
      };
      
      return eventSource;
    }
    
    async function analyze({artist,title,style,language}){
      const startRes = await startAnalysis({artist,title,style,language});
      return connectToProgress(startRes.request_id);
    }
    
    async function summarizeOnly({artist,title,style,language}){
      const res=await fetch('/api/summarize',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({artist,title,style,language})
      });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    
    async function generateOnly({artist,title,style,language}){
      const res=await fetch('/api/generate',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({artist,title,style,language})
      });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    
    async function searchSpotify({artist,title}){
      const res=await fetch('/api/spotify/search',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({artist,title})
      });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    
    function displaySpotifyTrack(spotifyData) {
      if (!spotifyData.found || !spotifyData.track) {
        musicPlayer.style.display = 'none';
        return;
      }
      
      const track = spotifyData.track;
      
      // Update track info
      trackName.textContent = track.name;
      trackArtist.textContent = track.artist;
      trackImage.src = track.image_url || '';
      trackImage.style.display = track.image_url ? 'block' : 'none';
      
      // Setup Spotify link
      openSpotifyBtn.href = track.external_url;
      
      // Setup preview if available
      if (track.preview_url) {
        previewAudio.src = track.preview_url;
        previewAudio.style.display = 'block';
        previewControls.style.display = 'block';
        
        playPreviewBtn.onclick = () => {
          if (previewAudio.paused) {
            previewAudio.play();
            playPreviewBtn.textContent = '‚è∏Ô∏è Pause Preview';
          } else {
            previewAudio.pause();
            playPreviewBtn.textContent = 'üéµ Preview (30s)';
          }
        };
        
        previewAudio.onended = () => {
          playPreviewBtn.textContent = 'üéµ Preview (30s)';
        };
      } else {
        previewAudio.style.display = 'none';
        previewControls.style.display = 'none';
      }
      
      // Show the music player
      musicPlayer.style.display = 'block';
    }
    
    async function analyzeDemo({artist,title,style,language}){
      await new Promise(r=>setTimeout(r,800));
      const svg=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#1f2937"/><text x="50%" y="50%" fill="#e5e7eb" font-size="46" text-anchor="middle">${escapeXML(artist)} ‚Äî ${escapeXML(title)}</text><text x="50%" y="585" fill="#cbd5e1" font-size="22" text-anchor="middle">AI demo artwork (${escapeXML(style||'default')})</text></svg>`;
      const summary = language === 'uk' ? `'${title}' –≤–∏–∫–æ–Ω–∞–≤—Ü—è ${artist} —Ä–æ–∑–ø–æ–≤—ñ–¥–∞—î –ø—Ä–æ –≤—ñ—Ä–Ω—ñ—Å—Ç—å...` : `${title} by ${artist} explores loyalty...`;
      return {summary,imageUrl:'data:image/svg+xml;base64,'+toBase64UTF8(svg)};
    }
    
    form.addEventListener('submit',async e=>{
      e.preventDefault();
      const artist=form.artist.value.trim(),title=form.title.value.trim(),style=form.style.value.trim(),language=form.language.value;
      if(!artist||!title)return showError('Please provide both artist and song title.');
      setLoading(true);
      try{
        await analyze({artist,title,style,language});
      }catch(err){
        showError(err.message);
        setLoading(false);
      }
    });
    
    summarizeBtn.addEventListener('click',async e=>{
      e.preventDefault();
      const artist=form.artist.value.trim(),title=form.title.value.trim(),style=form.style.value.trim(),language=form.language.value;
      if(!artist||!title)return showError('Please provide both artist and song title.');
      setLoading(true);
      updateProgress(50, 'Analyzing lyrics...');
      try{
        const [data, spotifyData] = await Promise.all([
          summarizeOnly({artist,title,style,language}),
          searchSpotify({artist,title})
        ]);
        summaryEl.textContent=data.summary;
        displaySpotifyTrack(spotifyData);
        updateProgress(100, 'Summary complete!');
        setTimeout(() => setLoading(false), 500);
      }catch(err){
        showError(err.message);
        setLoading(false);
      }
    });
    
    generateBtn.addEventListener('click',async e=>{
      e.preventDefault();
      const artist=form.artist.value.trim(),title=form.title.value.trim(),style=form.style.value.trim(),language=form.language.value;
      if(!artist||!title)return showError('Please provide both artist and song title.');
      setLoading(true);
      updateProgress(50, 'Generating AI artwork...');
      try{
        const [data, spotifyData] = await Promise.all([
          generateOnly({artist,title,style,language}),
          searchSpotify({artist,title})
        ]);
        imageEl.src=data.imageUrl;
        displaySpotifyTrack(spotifyData);
        updateProgress(100, 'Artwork complete!');
        setTimeout(() => setLoading(false), 500);
      }catch(err){
        showError(err.message);
        setLoading(false);
      }
    });
    
    demoBtn.addEventListener('click',async e=>{
      e.preventDefault();
      const artist=form.artist.value.trim()||'Metallica',title=form.title.value.trim()||'Nothing Else Matters',style=form.style.value.trim(),language=form.language.value;
      setLoading(true);
      // Simulate progress for demo
      for(let i = 0; i <= 100; i += 10) {
        updateProgress(i, i < 30 ? 'Searching lyrics...' : i < 70 ? 'Analyzing meaning...' : i < 100 ? 'Generating artwork...' : 'Complete!');
        await new Promise(r => setTimeout(r, 80));
      }
      const [data, spotifyData] = await Promise.all([
        analyzeDemo({artist,title,style,language}),
        searchSpotify({artist,title})
      ]);
      summaryEl.textContent=data.summary;
      imageEl.src=data.imageUrl;
      displaySpotifyTrack(spotifyData);
      setLoading(false);
    });
  </script>
</body>
</html>
